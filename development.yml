version: '2'

services:

  db:
    build: postgres
    ports:
      - "6432:5432"
    volumes_from:
      - data

  redis:
    image: redis

  esclient:
    # build: ./elasticsearch/
    image: eeacms/elastic:bise
    command: # Single node
          - elasticsearch
          - -Des.node.data=true
          - -Des.http.enabled=true
          - -Des.node.master=true
          - -Des.node.river=_none_
          - -Des.transport.tcp.compress=true
          - -Des.http.max_content_length=100mb
    ports:
      - "9200:9200"
    volumes_from:
      - data

  web:
    image: eeacms/bise.catalogue:latest
    # build: ./src/bise.catalogue
    environment:
      - RAILS_ENV=development
    command: rails server -b "0.0.0.0"
    volumes:
      - ./src/bise.catalogue:/app
      - ./config/development/config/ldap.yml:/app/config/ldap.yml
      - ./config/development/config/database.yml:/app/config/database.yml
      - ./config/development/config/elasticsearch.yml:/app/config/elasticsearch.yml
      - ./config/development/config/redis.yml:/app/config/redis.yml
      - ./config/development/ssmtp.conf:/etc/ssmtp/ssmtp.conf
      - ./var/tmp:/app/tmp
    volumes_from:
      - data
    ports:
      - "4000:3000"

  webprod:
    image: eeacms/bise.catalogue:latest
    environment:
      - RAILS_ENV=production
    command: tail -f /dev/null
    volumes:
      - ./src/bise.catalogue:/app
      - ./config/production/config/ldap.yml:/app/config/ldap.yml
      - ./config/production/config/database.yml:/app/config/database.yml
      - ./config/production/config/elasticsearch.yml:/app/config/elasticsearch.yml
      - ./config/production/config/redis.yml:/app/config/redis.yml
      - ./config/production/ssmtp.conf:/etc/ssmtp/ssmtp.conf
      - ./src/bise.catalogue/config/environments/devproduction.rb:/app/config/environments/production.rb
      - ./var/tmp-prod:/app/tmp
    volumes_from:
      - data
    ports:
      - "5000:3000"

  worker:
    image: eeacms/bise.catalogue:latest
    environment:
      - RAILS_ENV=development
    command: bundle exec sidekiq -L /app/log/sidekiq.log -q default -e development
    volumes:
      - ./src/bise.catalogue:/app
      - ./config/development/config/ldap.yml:/app/config/ldap.yml
      - ./config/development/config/database.yml:/app/config/database.yml
      - ./config/development/config/elasticsearch.yml:/app/config/elasticsearch.yml
      - ./config/development/config/redis.yml:/app/config/redis.yml
      - ./config/development/ssmtp.conf:/etc/ssmtp/ssmtp.conf
      - ./var/log:/app/log
    volumes_from:
      - data

  data:
    build: ./data
    volumes:
      - ./var/tmp:/tmp
      - ./snapshots:/snapshots:z
