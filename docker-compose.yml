db:
  image: postgres:8.4
  ports:
    - "5432"
  volumes_from:
    - data
redis:
  image: redis
elasticsearch:
  build: elasticsearch
  command: 
    - elasticsearch
    - Des.cluster.name="Catalogue Cluster"
    - Des.node.name="Catalogue Master Node"
    - Des.node.master=true
    - Des.index.number_of_shards=5
    - Des.index.number_of_replicas=1
    - Des.transport.tcp.compress=true
    - Des.http.max_content_length=100mb
  ports:
    - "9200:9200"
  volumes_from:
    - data
web:
  image: eeacms/bise.catalogue:assets
  environment:
    - RAILS_ENV=production
  command: bundle exec rails server -p 3000 -b '0.0.0.0'
  volumes:
    - ./bise-catalogue/config/ldap.yml:/app/config/ldap.yml
    - ./bise-catalogue/config/database.yml:/app/config/database.yml
    - ./bise-catalogue/config/elasticsearch.yml:/app/config/elasticsearch.yml
    - ./bise-catalogue/config/redis.yml:/app/config/redis.yml
    - ./production.rb:/app/config/environments/production.rb
  volumes_from:
    - data
  ports:
    - "3000:3000"
  links:
    - db
    - elasticsearch
    - redis
worker:
  image: eeacms/bise.catalogue:latest
  environment:
    - RAILS_ENV=production
  command: bundle exec sidekiq -d -L log/sidekiq.log -q default -e production
  volumes:
    - ./bise-catalogue/config/ldap.yml:/app/config/ldap.yml
    - ./bise-catalogue/config/database.yml:/app/config/database.yml
    - ./bise-catalogue/config/elasticsearch.yml:/app/config/elasticsearch.yml
    - ./bise-catalogue/config/redis.yml:/app/config/redis.yml
  volumes_from:
    - data
  links:
    - db
    - redis

data:
  build: data
